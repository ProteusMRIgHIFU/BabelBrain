# Standalone application
Ready-to-use applications (no need for Python installation) for macOS are available in the Releases section. Download the installer and drag "BabelBrain" into the Applications folder.

<img src="install1.png" height=300px>

The first time you will use you may be prompted to authorize it to run and access directories. You may also need to authorize it in the Security settings of macOS.

Keep a copy of the `PlanningModels` and `ThermalProfiles` directories. `PlanningModels` contain STL files useful for the planning of TUS. `ThermalProfiles` contains examples of timings of the TUS exposure (total duration on, duration off, duty cycle).

## Extra requirements for operation
## OS
Currently, only macOS and Linux are supported. The limitation comes mainly from some underlying supporting libraries (such as antspyx) that are only available in macOS and Linux. Windows users can run BabelBrain via [WSL2](https://learn.microsoft.com/en-us/windows/wsl/install) with NVidia GPUs (see this [guide](https://docs.nvidia.com/cuda/wsl-user-guide/index.html)). 

### GPU
BabelBrain supports GPUs enabled via CUDA, OpenCL or Metal. High-end GPUs (12 GPU RAM or more) are recommended. ARM64 processors (M1, M2) in Mac systems with 32GB or more RAM are highly recommended. BabelBrain was designed with Mac systems based on M1 and M2 processors as main targets. 

### FSL
[FSL](https://fsl.fmrib.ox.ac.uk/fsl/fslwiki)'s flirt tool must be installed and FSL's init scripts must be activated in the .bash_profile or .zsh_profile.

### Blender
[blender](https://www.blender.org) is required for constructive solid geometry operations.

### SimNIBS
While BabelBrain does not invoke directly SimNIBS tools, BabelBrain depends on the output generated by SimNIBS 3.x `headreco` or SimNIBS 4.x `charm` processing tools. Consult the [Releases](https://github.com/simnibs/simnibs/releases) section in SimNIBS for installation options. We recommended using SimNIBS 4.x `charm` for better results.

### Navigation-planning software
While not strictly required, it is highly recommended to use planning software to establish the target localization and orientation, called **trajectory** in the following of this documentation, of the ultrasound transducer for the simulation of transcranial ultrasound. The trajectory is just a transformation matrix in the T1W space that represents the translation-rotation of a vector describing the path of ultrasound. BabelBrain can import trajectories defined in proprietary software (Rogue Research's Brainsight) or open-source visualization software ([3DSlicer](https://www.slicer.org/)). Instructions are detailed in the pipeline section of this documentation. 

## Manual Installation 
Clone the [BabelBrain](https://github.com/ProteusMRIgHIFU/BabelBrain/) repository. The code can be run in a Python environment (in Linux, for example), the requirements are roughly a clean Python 3.9 or 3.10 environment and a healthy XCode installation with command line tools installed in MacOS or an LTS Ubuntu installation such as 20.04. 

* Python 3.9/3.10. Anaconda/miniconda is recommended. - if running in Apple new ARM64 processors (M1, M1 Max, etc.), be sure of using a native ARM64 version. Several YAML conda environment files are in the main repository of [BabelBrain] https://github.com/ProteusMRIgHIFU/BabelBrain. 

*Note: BabelBrain uses `antspyx`, which can take a longtime to compile if a wheel is not available*.

# Running
## Standalone macOS application
Just open BabelBrain from the Applications section in macOS.

## Manual execution
Activate the conda environment, change to the `BabelBrain/BabelBrain` directory and run

`python BabelBrain.py`

### Building standalone application
A Pyinstaller specification file is provided to build the macOS application. In the `BabelBrain/BabelBrain` directory run

`pyinstaller BabelBrain.spec --noconfirm`

A new application will be created at `BabelBrain/BabelBrain/dist/`

A DMG image installer can be created with the `BabelBrain/BabelBrain/create_dmg.sh` script. You need to install `create-dmg` tool with homebrew. 