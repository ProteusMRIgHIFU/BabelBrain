<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://proteusmrghifu.github.io/BabelBrain/pipeline/pipeline.html">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Simulation pipeline - BabelBrain</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../index.html">BabelBrain</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../index.html" class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../installation.html" class="nav-link">Installation</a>
                            </li>
                            <li class="navitem active">
                                <a href="pipeline.html" class="nav-link">Simulation pipeline</a>
                            </li>
                            <li class="navitem">
                                <a href="../results/results.html" class="nav-link">Results files</a>
                            </li>
                            <li class="navitem">
                                <a href="../Appendix/Appendix.html" class="nav-link">Appendix</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../installation.html" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../results/results.html" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#pipeline-description" class="nav-link">Pipeline description</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#1-preliminary-steps" class="nav-link">1 - Preliminary steps</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#1a-availability-of-ctzte-scans" class="nav-link">1.a - Availability of CT/ZTE scans</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#2-planning" class="nav-link">2 - Planning</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#2a-planning-with-3dslicer" class="nav-link">2.a - Planning with 3DSlicer</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2b-planning-with-brainsight" class="nav-link">2.b - Planning with Brainsight</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#3-simulation-with-babelbrain" class="nav-link">3 - Simulation with BabelBrain</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#3a-input-data" class="nav-link">3.a - Input data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3b-domain-generation" class="nav-link">3.b - Domain generation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3c-transcranial-ultrasound-simulation" class="nav-link">3.c - Transcranial ultrasound simulation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3d-thermal-simulation" class="nav-link">3.d - Thermal simulation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="pipeline-description">Pipeline description</h2>
<p>BabelBrain takes 3D imaging data (MRI and, if available, CT) along with a trajectory indicating the location and orientation of an ultrasound transducer to target a location in the brain.</p>
<p><img src="Basics-1.png"></p>
<p>Currently, five types of transducers are supported:</p>
<ul>
<li><strong>Single</strong>. This is a simple focusing single-element transducer. The user can specify diameter, focal length and a frequency between 100 kHz and 700 kHz.</li>
<li><strong>H317</strong>. This is a 128-element phased array with a focal length of 135 mm and F#=0.9. The device is capable to operate at 250 kHz and 700 kHz.</li>
<li><strong>CTX_500</strong>. This is a device commercialized by the company NeuroFUS that has 4 ring elements, with a focal length of 63.2 mm and F# = 0.98, and operates at 500 kHz.</li>
<li><strong>H246</strong>. This is a flat ring-type device that has 2 annular elements, with a diameter of 33.6 mm and operates at 500 kHz. It offers some degree of focusing by using two transducer elements.</li>
<li><strong>BSonix</strong>. These are devices commercialized by the company Brainsonix at fixed focal lengths of 55, 65 and 80 mm as reported in <a href="https://doi.org/10.1109/TUFFC.2020.3006781">Schafer <em>et al.</em></a>.</li>
</ul>
<p>The specific capabilities of each transducer are considered during the simulations. </p>
<h1 id="1-preliminary-steps">1 - Preliminary steps</h1>
<ul>
<li><strong>Mandatory</strong>: Collect T1W (and optionally T2W) imaging of a participant. Highly recommended to use 3D isotropic (1 mm-resolution) scans.</li>
<li>
<p><strong>Mandatory</strong>: Execute  SimNIBS 3.x <code>headreco</code> or SimNIBS 4.x <code>charm</code> processing tool:</p>
<p><code>headreco all &lt;ID&gt; &lt;Path to T1W Nifti file&gt; &lt;Path to T2W Nifti file&gt;</code></p>
<p>or</p>
<p><code>charm &lt;ID&gt; &lt;Path to T1W Nifti file&gt; &lt;Path to T2W Nifti file&gt;</code></p>
<p><code>&lt;ID&gt;</code> is a string for identification. A subdirectory <code>m2m_&lt;ID&gt;</code> will be created. Take note of this directory, this will be referred to as the <strong>SimNIBS output</strong> directory in the following of this manual.</p>
<p><strong>Note</strong>: Sometimes, <code>charm</code> may complain that the qform and sform matrices are inconsistent. We have observed this when converting DICOM datasets with <code>dcm2niix</code>. If <code>charm</code> complains, you can try passing the  <code>--forceqform</code> parameter when executing <code>charm</code>.  </p>
</li>
<li>
<p><strong>Mandatory</strong>: Identify the coordinates of the target of focus ultrasound in T1W space. If you need to start in standardized space (e.g. MNI), there are many tools (FSL, SPM12, etc) that can be used to convert from standardized space to T1W space. </p>
<p>For example, with FSL, a simple csv file (<code>mni.csv</code>) can be created with the coordinates in MNI such as <code>-32.0 -20.0 65.0</code>. Then run the following commands</p>
<p><code>flirt -in &lt;path to T1W nifti&gt; -ref $FSLDIR/data/standard/MNI152_T1_1mm -omat anat2mni.xfm -out anat_norm</code></p>
<p><code>std2imgcoord -img &lt;path to T1W nifti&gt;  -std $FSLDIR/data/standard/MNI152_T1_1mm.nii -xfm anat2mni.xfm mni.csv &gt; natspace.csv</code></p>
<p>The file <code>natspace.csv</code> will contain the MNI coordinates converted to T1W space. Please note that often visual inspections could be required to confirm the location.</p>
</li>
<li>
<p><em>Optional</em>: CT scan of the participant. Depending on the study being conducted, counting with a CT scan improves the precision of the simulation. </p>
</li>
<li><em>Optional</em>:: ZTE scan of the participant. A pseudo-CT scan can be reconstructed using a Zero Echo Time (ZTE) MRI scan. Details on MRI scan parameters and methods for pseudo-CT reconstruction (using the "classical" approach) can be found in the work presented by <a href="https://ieeexplore.ieee.org/document/9856605">Miscouridou <em>et al.</em></a> (DOI: 10.1109/TUFFC.2022.3198522). The user needs only to provide the Nifti file of the ZTE scan. BabelBrain will do the transformation to pseudo-CT as detailed in Miscouridou <em>et al.</em> A Nifti file with the pseudo-CT will be generated.</li>
</ul>
<h2 id="1a-availability-of-ctzte-scans">1.a - Availability of CT/ZTE scans</h2>
<p>If no CT or ZTE scans are available, a mask representing the skull bone will be generated from the <code>headreco</code> or <code>charm</code> tools output. Be sure of inspecting the generated mask Nifti file to ensure the mask is correctly calculated. Our experience indicates that <code>charm</code> tool produces a better skull mask extraction. When using only T1W and T2W as inputs, BabelBrain uses a generic mask to represent the skull bone (including regions of trabecular and cortical bone). Average values of speed of sound and attenuation are assigned to these bone layers. Consult the appendix section for details on the values used.</p>
<p>If a CT or ZTE scan is provided, a mapping of density, speed of sound and attenuation will be produced. Consult the appendix section for details on the mapping procedure.</p>
<h1 id="2-planning">2 - Planning</h1>
<p><img src="Pipeline-1.png" height=300px></p>
<p>The goal of the planning step is to produce a <strong>trajectory</strong> that provides the location where ultrasound is intended to be focused and the orientation of the transducer in T1W coordinate space. In practice, the trajectory is just an affine matrix applied to a "virtual" needle that describes the <strong>location</strong> and <strong>orientation</strong> where focused ultrasound is desired to be concentrated. The tip of the trajectory needs to be at the intended target. The position of the transducer will be relative to the tip location. The details using 3DSlicer can illustrate this.</p>
<h4 id="acoustic-path-stl-helpers">Acoustic path STL helpers</h4>
<p>BabelBrain includes a series of complementary STL files representing the "acoustic" path. Each STL file includes a group of circular meshes combined with a target needle that represent the acoustic cross sections of a field produced with a transducer with F#=1.0 at different depths. As noted in the instructions below, these meshes help to verify a correct alignment with the skin.</p>
<h2 id="2a-planning-with-3dslicer">2.a - Planning with 3DSlicer</h2>
<ol>
<li>Install the <strong>SlicerIGT</strong> extension in 3DSlicer (restart 3DSlicer if requested)</li>
<li>
<p>Load T1W planning data</p>
<p><img src="Planning-1.png"></p>
</li>
<li>
<p>In the IGT extension menu, select "Create Models"</p>
<p><img src="Planning-2.png" height=350px></p>
</li>
<li>
<p>Load one of the STL helpers as a <code>model</code> with <code>RAS</code> coordinate convention. The model will appear by default centred in the T1W space and pointing in the inferior<span class="arithmatex"><span class="MathJax_Preview">\rightarrow</span><script type="math/tex">\rightarrow</script></span>superior direction</p>
<p><img src="Planning-4b.png" height=300px></p>
<p>Alternatively, you can create a needle with a length of 100 mm. </p>
<p><img src="Planning-3.png" height=150px></p>
<p><img src="Planning-4.png" height=300px></p>
</li>
<li>
<p>Select the model in the data panel and edit the properties to make it appear in the "Slice Display"</p>
<p><img src="Planning-5.png" height=250px></p>
</li>
<li>
<p>Create a new transform and give it a name related to the target (e.g. LGPI, RSTN, LVIM, RM1, etc.). This is important as BabelBrain will use the name of the transform as a prefix for its output files.</p>
<p><img src="Planning-6.png" height=200px></p>
<p>Apply the transform to the  model and be sure the transformation is set to <code>local</code> (little button next to the "invert" button)</p>
<p><img src="Planning-7.png" height=400px></p>
</li>
<li>
<p>Select "Volume Reslice Driver" in the IGT module menu</p>
<p><img src="Planning-8.png" height=450px></p>
</li>
<li>
<p>Select the linear transform in the two first slice views</p>
<p><img src="Planning-9.png" height=110px></p>
</li>
<li>
<p>Select one view to be "Inplane" and the other to be "Inplane 90"</p>
<p><img src="Planning-10.png" height=120px></p>
</li>
<li>
<p>In the Data panel, select the linear transform and edit properties, you should be able to see the slice views aligned along the model </p>
<p><img src="Planning-11b.png" height=400px></p>
</li>
<li>
<p>Adjust the location of the tip of the needle using the <strong>translation</strong> (LR, PA, IS) controls to match the tip of the model to your area of interest.</p>
<p><img src="Planning-12.png" height=300px></p>
</li>
<li>
<p>Adjust the trajectory path using the <strong>rotation</strong> (LR, PA, IS) controls until finding a trajectory that has a clear path and mimics how the transducer will be placed. Tip: Adjust the trajectory to make it orthogonal to the skin surface in the inline and inline90 views; this recreates the condition of placing a transducer aligned relative to the skin.</p>
<p><img src="Planning-13.png" height=400px></p>
<p>Note: If you navigate to other windows in 3DSlicer, the transition and rotation control may be set back to 0s. But the transformation matrix will remain with the latest values applied. Any other adjustment will be added to the transformation matrix. Be sure that the <code>local</code> option is always selected.</p>
</li>
<li>
<p>Save the transformation in text format. Select "Save data" and select text as the file format. Take note of the path. Suggestion: Select a directory in the same path where T1W or SimNIBS output is located. </p>
</li>
</ol>
<h2 id="2b-planning-with-brainsight">2.b - Planning with Brainsight</h2>
<p>Alternatively, planning can also be performed with the proprietary software Brainsight made by Rogue Research (Montreal, Canada) for the planning and execution of non-invasive neuromodulation. This software has an existing feature that exports a trajectory that can be used in BabelBrain. The workflow to export a trajectory is very similar to 3DSlicer.</p>
<ol>
<li>Create a new "empty" or "SimNIBS" project; use SimNIBS only if you used SimNIBS 3.x with <code>headreco</code>.</li>
</ol>
<p><img src="Planning-14.png" height=200px></p>
<ol>
<li>
<p>Load T1W planning data.  If using  "SimNIBS" project, it will preload the T1W imaging dataset.</p>
<p><img src="Planning-15.png" height=250px></p>
</li>
<li>
<p>Open target window</p>
<p><img src="Planning-16.png" height=250px></p>
</li>
<li>
<p>Adjust coordinates and orientation with control in the user interface (right side of screen)</p>
<p><img src="Planning-17.png" height=400px></p>
</li>
<li>
<p>Create a new target as a trajectory</p>
<p><img src="Planning-18.png" height=200px></p>
</li>
<li>
<p>Rename the trajectory with a name related to the target (e.g. LGPI, RSTN, LVIM, RM1, etc.)</p>
</li>
<li>
<p>Export trajectory with "Export" function and select "Orientation (3 directions vectors)" and "NifTI:Scanner" as the coordinate system. Take note of the path. Suggestion: Select a directory in the same path where T1W or SimNIBS output is located. </p>
<p><img src="Planning-19.png" height=250px></p>
</li>
</ol>
<h1 id="3-simulation-with-babelbrain">3 - Simulation with BabelBrain</h1>
<p>Now that planning is done, open BabelBrain either from the Applications menu in macOS if the DMG installer was used or with <code>python BabelBrain.py</code> as indicated in the installation section.</p>
<p><img src="Simulation-1.png" height=150px></p>
<h2 id="3a-input-data">3.a - Input data</h2>
<p>An input dialog will prompt the different input files required for the simulation.
<img src="Simulation-2.png" height=250px></p>
<ol>
<li>Specify the path to the trajectory file and the source (Slicer or Brainsight)</li>
<li>Select the SimNIBS output directory associated to this test and indicate what tool was used to generate it (<code>headreco</code> or <code>charm</code>)</li>
<li>Select the path to the T1W Nifti file</li>
<li>Indicate if CT scan is available. Options are "No", "real CT" or "ZTE". Select if coregistration of CT to T1W space must be performed. Depending on your specific preliminary steps, you may have CT already coregistered in T1W space. If coregistration is done by BabelBrain, the resolution of the CT will be preserved. The T1W file will be first bias-corrected and upscaled to the CT resolution and then the CT will be coregistered using the <code>itk-elastix</code> package with rigid coregistration.</li>
<li>
<p>Select a thermal profile file for simulation. This is a simple YAML file where the timings of transcranial ultrasound are specified. For example:</p>
<p><code>BaseIsppa: 5.0 # W/cm2
AllDC_PRF_Duration: #All combinations of timing that will be considered
-   DC: 0.3
    PRF: 10.0
    Duration: 40.0
    DurationOff: 40.0</code></p>
<p>This definition helps in the step of thermal simulation with BabelBrain. <code>BaseIsspa</code> is the reference value of acoustic intensity for which the thermal equation will be solved. You can set this to 5 W/cm<span class="arithmatex"><span class="MathJax_Preview">^2</span><script type="math/tex">^2</script></span>. Choices for other powers will be scaled (no recalculations) based on this value.</p>
<p>More than one exposure can be specified. For example:</p>
<p><code>BaseIsppa: 5.0 # W/cm2
 AllDC_PRF_Duration: #All combinations of timing that will be considered
     -   DC: 0.3
         PRF: 10.0
         Duration: 40.0
         DurationOff: 40.0
     -   DC: 0.1
         PRF: 5.0
         Duration: 80.0
         DurationOff: 50.0</code></p>
<p>When running the thermal simulation step, all the combinations specified in the thermal profile will be calculated. </p>
</li>
<li>
<p>Select the type of transducer to be used in simulations.</p>
</li>
<li>
<p>Once all inputs are set, then click on "CONTINUE"</p>
</li>
</ol>
<h2 id="3b-domain-generation">3.b - Domain generation</h2>
<p>The diagram below shows flowchart describing the process for the domain generation.</p>
<p><img src="nsclc-V2.svg" height=700px></p>
<p>The first step after specifying input data is to create the simulation domain. The available operating frequencies will depend on the selected transducer. The second main input is the resolution of the simulation expressed in the number of points per wavelength (PPW). The minimum for fast estimation is 6 PPW, and 9 PPW to meet criteria de convergence when compared to other <a href="https://asa.scitation.org/doi/10.1121/10.0013426">numerical tools</a>.
 Depending on if CT or ZTE scans are available, options to fine-tune the domain generation will be available. For CT scans, the user can adjust the threshold for bone detection (set by default to 300 HU). For ZTE scans the user can specify the thresholds to select normalized ZTE signal (by default 0.1 and 0.6) to convert to pseudo-CT. Please consult Miscouridou <em>et al.</em>](https://ieeexplore.ieee.org/document/9856605) for details on the "classical" approach to convert from ZTE to pseudo-CT.
 The execution time in M1 Max processor can take from 1 minute of minutes up to 10 minutes depending on the resolution and availability of ZTE/CT scans.
 When initiating the calculations, a detailed log output will appear in the bottom region of the window. In case of any error during processing, a dialog message will prompt indicating to consult this window for more details. Once executed, orthogonal views of the domain will be shown. T1W scan is also shown to verify that the mask was correctly calculated. </p>
<p><img src="Simulation-3.png" height=450px></p>
<p>Once executed, a Nifti file containing the mask describing the different tissue regions will be produced in the directory where the T1W Nifit file is located. It will have a file with the following structure:
<code>&lt;Name of target file&gt;_&lt;Frequency&gt;_&lt;PPW&gt;_BabelViscoInput.nii.gz</code>, for example <code>LinearTransform_500kHz_6PPW_BabelViscoInput.nii.gz</code>. The mask will be in T1W space, facilitating its inspection as overlay with T1W data. The mask has values of 1 for skin, 2 for cortical bone, 3 for trabecular and 4 for brain tissue. A single voxel with a value of 5 indicates the location of the target. The raw data inside the Nifti file is organized in a 3D Cartesian volume that is aligned to the transducer acoustic axis. The Nifti affine matrix ensures the mask can be inspected in T1W space.</p>
<p>If a CT or ZTE dataset is indicated as input, the skull mask will be created using this scan rather than the output of <code>headreco</code> or <code>charm</code>. Also, an overlay of the CT/pseudo-CT will be also shown for verification purposes. </p>
<p><img src="Simulation-4.png" height=450px> </p>
<p>Please note if a <code>&lt;Name of target file&gt;_&lt;Frequency&gt;_&lt;PPW&gt;_BabelViscoInput.nii.gz</code> file exists, the GUI will ask confirmation to recalculate the mask. Selecting "No" will load the previous mask. </p>
<p>If using output from <code>headreco</code>, the STL files for skin, csf and bone are used to produce the high-resolution mask via GPU-accelerated voxelization. </p>
<p>If using output from <code>charm</code> (which does not produces STL files), equivalent STL files are produced from the file <code>final_tissues.nii.gz</code> created by charm. Meshes are created and smoothed (Laplace filtering), and the mask for simulation is calculated via GPU-accelerated voxelization. The STL files of skin, csf and bone will be saved in the output directory of SimNIBS by BabelBrain. </p>
<h2 id="3c-transcranial-ultrasound-simulation">3.c - Transcranial ultrasound simulation</h2>
<p>The second tab in the GUI of BabelBrain shows the ultrasound simulation step.  The diagram below shows a flowchart of this step.</p>
<p><img src="nsclc2-V2.svg" height=600px></p>
<p>The choices of this tab will depend on the selected transducer. Simulation results in this step are shown in normalized conditions. The final step (see below) later will show the results denormalized in function of the selected intensity at the target. Common to all transducers, the distance of the maximal depth beyond the target location is set to a user-configurable distance of 40 mm.</p>
<h3 id="3ci-ctx_500">3.c.i - CTX_500</h3>
<p>For the CTX_500 transducer, the initial assumption is that this type of transducer will be placed in direct contact with the skin and that the focusing distance will be adjusted according to the desired target. </p>
<p><img src="Simulation-5.png" height=350px></p>
<p>The initial "TPO Distance" (an adjustable parameter in the CTX_500 device) is calculated based on the distance skin to the target. </p>
<p>It is recommended to simulate with the default values to evaluate the degree of focus shift caused by the skull. Simulation should take a couple of minutes in a M1 Max system.</p>
<p><img src="Simulation-6.png" height=450px> </p>
<p>The results window will show two orthogonal views of normalized acoustic intensity. The intensity in the skin and skull regions is masked out (it can be visualized later in those regions in step 3). In this step, the main goal is to ensure a correct spatial focusing on the target. In the example, a shift of 5 mm of the focal spot towards the transducer can be observed. This shift can be corrected by adding 5 mm in the TPO Distance input (in the example, we adjust to 52.5 mm). Also, there is a small lateral shift in the negative "Y" direction. This can be corrected with the "Mechanical" adjustment controls (in this example we adjust +1mm in the Y direction). Please note that in the simulation domain, X, Y and Z are not mapped to subject coordinates. However, at the end of the simulations, there will be a report in which direction in the T1W space this adjustment translates. </p>
<p>After doing the adjustments, the simulation can be repeated.</p>
<p><img src="Simulation-7.png" height=450px> </p>
<h3 id="3cii-h246">3.c.ii - H246</h3>
<p>The H246 transducer has a similar operation as the CTX_500. The steps presented above apply similarly. As the H246 transducer has a much longer focal length, consider extending the maximal depth of simulations.</p>
<p><img src="Simulation-9.png" height=450px></p>
<h3 id="3ciii-h317">3.c.iii - H317</h3>
<p>The H317 is a large transducer that uses a coupling cone that is in contact with the skin. The user interface shows small differences compared to CTX_500 and H246. There is a parameter for the <code>Distance cone to Focus</code> that depends on the acoustic cone used for coupling. Because this transducer has 128 elements, the user interface shows also the option to perform electronic refocusing.</p>
<p><img src="Simulation-10.png" height=450px></p>
<h3 id="3civ-single">3.c.iv - Single</h3>
<p>The "Single" transducer is a generic device with a configurable diameter and focal length. Because this is a more general-purpose device, it is not assumed that the transducer is in direct contact with the skin. The transducer is always initially centered at the target, which can make that there could be some space between the transducer out plane and the skin. The user can adjust the mechanical distance on the Z axis until the point the out plane of the transducer reaches the skin.</p>
<p><img src="Simulation-11.png" height=450px></p>
<h3 id="3civ-bsonix">3.c.iv - BSonix</h3>
<p>These are commercial transducers with fixed focal lengths as reported in <a href="https://doi.org/10.1109/TUFFC.2020.3006781">Schafer <em>et al.</em></a>. The user can select focal length of 55, 65 and 80 mm. Similar to the CTX_500, it is assumed the device is in direct contact with the skin, with the option to move the transducer away from the skin to simulate placing a coupling pad. </p>
<p><img src="Simulation-13.png" height=450px></p>
<h2 id="3d-thermal-simulation">3.d - Thermal simulation</h2>
<p>The third tab in the GUI of BabelBrain shows the thermal simulation step.  The diagram below shows a flowchart of this step.</p>
<p><img src="nsclc3-V2.svg" height=250px></p>
<p>The thermal simulation solves the Bio-heat thermal equation (BHTE) for all the combinations of duty cycle, timing and ultrasound exposure indicated in the thermal profile definition file. </p>
<p><img src="Simulation-12.png" height=450px></p>
<p>The selection of spatial-peak pulse-average intensity (<span class="arithmatex"><span class="MathJax_Preview">I_{\text{SPPA}}</span><script type="math/tex">I_{\text{SPPA}}</script></span>) indicates the desired intensity at the target. The spatial-peak time-average intensity (<span class="arithmatex"><span class="MathJax_Preview">I_{\text{SPTA}}</span><script type="math/tex">I_{\text{SPTA}}</script></span>) is calculated based on the selected timing conditions.  Based on the selections of timing and desired <span class="arithmatex"><span class="MathJax_Preview">I_{\text{SPPA}}</span><script type="math/tex">I_{\text{SPPA}}</script></span> in tissue, the <span class="arithmatex"><span class="MathJax_Preview">I_{\text{SPPA}}</span><script type="math/tex">I_{\text{SPPA}}</script></span> in water conditions is calculated after taking into account all the losses. Thermal safety parameters (maximal temperature and thermal doses) in the skin, skull bone and brain tissue are calculated at the locations showing the highest temperature elevation in the whole 3D volume. The <code>MTB</code>, <code>MTS</code> and <code>MTC</code> push buttons in the lower region of the interface select the slice corresponding to the the maximal temperature in brain, skin and skull, respectively.</p>
<p>The <code>Export summary (CSV)</code> action exports the input data paths and user selections used for the simulations. It also includes a table of <span class="arithmatex"><span class="MathJax_Preview">I_{\text{SPPA}}</span><script type="math/tex">I_{\text{SPPA}}</script></span> in water conditions and safety metrics in function of the desired <span class="arithmatex"><span class="MathJax_Preview">I_{\text{SPPA}}</span><script type="math/tex">I_{\text{SPPA}}</script></span> in tissue. Below there is an example of the exported data.</p>
<table>
<thead>
<tr>
<th>Isppa</th>
<th>IsppaWater</th>
<th>MI</th>
<th>Ispta</th>
<th>MTB</th>
<th>MTS</th>
<th>MTC</th>
<th>CEMBrain</th>
<th>CEMSkin</th>
<th>CEMSkull</th>
</tr>
</thead>
<tbody>
<tr>
<td>0.5</td>
<td>2.38</td>
<td>0.18</td>
<td>0.15</td>
<td>0.03</td>
<td>0.01</td>
<td>0.02</td>
<td>0.00033419</td>
<td>0.000329626</td>
<td>0.00033046</td>
</tr>
<tr>
<td>1</td>
<td>4.77</td>
<td>0.25</td>
<td>0.3</td>
<td>0.07</td>
<td>0.03</td>
<td>0.04</td>
<td>0.000343142</td>
<td>0.000333787</td>
<td>0.000335482</td>
</tr>
<tr>
<td>1.5</td>
<td>7.15</td>
<td>0.31</td>
<td>0.45</td>
<td>0.10</td>
<td>0.04</td>
<td>0.05</td>
<td>0.000352388</td>
<td>0.000338007</td>
<td>0.000340589</td>
</tr>
<tr>
<td>2</td>
<td>9.54</td>
<td>0.35</td>
<td>0.6</td>
<td>0.13</td>
<td>0.06</td>
<td>0.07</td>
<td>0.00036194</td>
<td>0.000342286</td>
<td>0.000345782</td>
</tr>
<tr>
<td>2.5</td>
<td>11.92</td>
<td>0.39</td>
<td>0.75</td>
<td>0.17</td>
<td>0.07</td>
<td>0.09</td>
<td>0.000371807</td>
<td>0.000346625</td>
<td>0.000351062</td>
</tr>
<tr>
<td>3</td>
<td>14.31</td>
<td>0.43</td>
<td>0.9</td>
<td>0.20</td>
<td>0.09</td>
<td>0.11</td>
<td>0.000382002</td>
<td>0.000351024</td>
<td>0.000356431</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
</tbody>
</table></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../mathjax-config.js" defer></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
