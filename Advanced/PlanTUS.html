<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://proteusmrghifu.github.io/BabelBrain/Advanced/PlanTUS.html">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>PlanTUS - BabelBrain</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../index.html">BabelBrain</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../index.html" class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../installation.html" class="nav-link">Installation</a>
                            </li>
                            <li class="nav-item">
                                <a href="../pipeline/pipeline.html" class="nav-link">Overall pipeline</a>
                            </li>
                            <li class="nav-item">
                                <a href="../pipeline/Preliminary_steps.html" class="nav-link">Preliminary steps</a>
                            </li>
                            <li class="nav-item">
                                <a href="../pipeline/Planning.html" class="nav-link">Planning</a>
                            </li>
                            <li class="nav-item">
                                <a href="../pipeline/BabelBrain.html" class="nav-link">BabelBrain simulation</a>
                            </li>
                            <li class="nav-item">
                                <a href="../MRISequences/MRISequences.html" class="nav-link">MRI sequences</a>
                            </li>
                            <li class="nav-item">
                                <a href="../results/results.html" class="nav-link">Results files</a>
                            </li>
                            <li class="nav-item">
                                <a href="advanced.html" class="nav-link">Advanced options</a>
                            </li>
                            <li class="nav-item">
                                <a href="PlanTUS.html" class="nav-link active" aria-current="page">PlanTUS</a>
                            </li>
                            <li class="nav-item">
                                <a href="TransducerCalibration.html" class="nav-link">Tx calibration</a>
                            </li>
                            <li class="nav-item">
                                <a href="../Appendix/Appendix.html" class="nav-link">Appendix</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="advanced.html" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="TransducerCalibration.html" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="2"><a href="#plantus-integration" class="nav-link">PlanTUS integration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#limitations" class="nav-link">Limitations</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#requirements" class="nav-link">Requirements</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#extra-libraries-in-simnibs-environment" class="nav-link">Extra libraries in SimNIBS environment</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#execution-of-plantus" class="nav-link">Execution of PlanTUS</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="plantus-integration">PlanTUS integration</h2>
<p>Starting in r0.8.0, there is an experimental feature to integrate with the excellent tool <a href="https://doi.org/10.1016/j.brs.2025.08.013">PlanTUS</a> developed by Maximilian Lueckel, Suhas Vijayakumar and Til Ole Bergmann from Mainz University that helps to refine trajectories using heatmaps of incident angles, distance, degree of intersection and skin-skull angle.</p>
<p><img src="PlanTUS-1.png" height=350px></p>
<p>This procedure in BabelBrain can update the trajectory defined originally in 3DSlicer or Brainsight to improve, for example, incident angle.</p>
<h1 id="limitations">Limitations</h1>
<ul>
<li>Operational to most devices excepting generic simple single element transducers; BSonix devices are supported (to be improved in future release). Currently, operation with single element devices will not produce a correct result.</li>
<li>Because some dependencies, only macOS and Linux are currently supported (to be improved in future release).</li>
<li>Multiple dependencies to external libraries (dependencies to be reduced in future release)</li>
</ul>
<p>In macOS and if using the binary distribution, it is recommended to run from the terminal to identify error messages during the execution that otherwise are not yet captured in the BabelBrain log window. For example</p>
<pre><code class="language-bash">/Applications/BabelBrain.app/Contents/MacOS/BabelBrain 
</code></pre>
<h1 id="requirements">Requirements</h1>
<p>In this initial integration, the integration needs the following extra packages:</p>
<ul>
<li><a href="https://fsl.fmrib.ox.ac.uk/fsl/docs/">FSL</a>.</li>
<li><a href="https://humanconnectome.org/software/connectome-workbench">Workbench connectome</a>. If on macOS <strong>Download the <a href="https://humanconnectome.org/storage/app/media/workbench/workbench-macub-v2.0.1.zip">zip version of version 2.0.1</a>. DO NOT DOWNLOAD the DMG version as currently that version is not properly signed and macOS will refuse to run it</strong>.</li>
<li><a href="https://surfer.nmr.mgh.harvard.edu">Freesurfer</a>. Tested with version 7.4.1.</li>
<li><a href="https://github.com/spichardo/PlanTUS">PlanTUS fork</a> needed to automate tasks.</li>
</ul>
<p>Download all the tools above and take note of paths for PlanTUS fork location and binary files of FSL, Workbench (location of <code>wb_command</code> binary) and Freesurfer.</p>
<p>Take also note of path to SimNIBS root path; for example <code>/Users/spichardo/Applications/SimNIBS-4.5</code>.</p>
<h2 id="extra-libraries-in-simnibs-environment">Extra libraries in SimNIBS environment</h2>
<p>Activate SimNIBS Python environment, for example:</p>
<pre><code class="language-bash">source &lt;path_to_SimNIBS_root&gt;/simnibs_env/bin/activate
</code></pre>
<p>Install extra libraries with</p>
<pre><code class="language-bash">pip install nilearn btk pynput
</code></pre>
<h2 id="execution-of-plantus">Execution of PlanTUS</h2>
<ul>
<li>Define location in Brainsight/Slicer and export trajectory/linear transformation.</li>
<li>Do not worry to adjust the trajectory manually as is usually done, as we expect to use the one calculated with PlanTUS. Just focus on the <strong>target location</strong>.</li>
</ul>
<p><img src="PlanTUS-2.png" height=450px></p>
<ul>
<li>
<p>Specify paths to tools in the Advanced Dialog
<img src="advanced-2-PlanTUS.png" height=250px></p>
</li>
<li>
<p>These paths will remain saved between BabelBrain sessions.</p>
</li>
<li>
<p>Click on <code>RUN PlanTUS</code> button. Execution will take only a couple of minutes. If all paths are correctly set, a multiple view window will show different heatmaps as below:</p>
</li>
</ul>
<p><img src="PlanTUS-3.png" height=350px></p>
<ul>
<li>
<p>All views are linked to inspect all heatmaps simultaneously (similar as in connectome workbench).</p>
</li>
<li>
<p>Click on “Selection Mode” and select a feasible location on the head’s surface. For example, one that minimizes incident angle. A small spherical marker will appear on the selected location as shown below</p>
</li>
</ul>
<p><img src="PlanTUS-4.png" height=350px></p>
<ul>
<li>Click on <code>Click on Generate Trajectory</code>.</li>
<li>A visualization of the transducer at the selected location will be shown</li>
</ul>
<p><img src="PlanTUS-5.png" height=300px></p>
<ul>
<li>When closing this window, a prompt will appear asking to update the target definition</li>
</ul>
<p><img src="PlanTUS-6.png" height=150px></p>
<ul>
<li>When running Step 1 in BabelBrain, you will see the new trajectory is the one selected with PlanTUS. </li>
</ul>
<p><img src="PlanTUS-7.png" height=400px></p>
<ul>
<li>This trajectory will be saved in the same directory as the original with the “_PlanTUS” suffix added in the filename</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../mathjax-config.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
