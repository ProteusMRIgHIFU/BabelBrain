<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://proteusmrghifu.github.io/BabelBrain/Advanced/TransducerCalibration.html">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Tx calibration - BabelBrain</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../index.html">BabelBrain</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../index.html" class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../installation.html" class="nav-link">Installation</a>
                            </li>
                            <li class="nav-item">
                                <a href="../pipeline/pipeline.html" class="nav-link">Overall pipeline</a>
                            </li>
                            <li class="nav-item">
                                <a href="../pipeline/Preliminary_steps.html" class="nav-link">Preliminary steps</a>
                            </li>
                            <li class="nav-item">
                                <a href="../pipeline/Planning.html" class="nav-link">Planning</a>
                            </li>
                            <li class="nav-item">
                                <a href="../pipeline/BabelBrain.html" class="nav-link">BabelBrain simulation</a>
                            </li>
                            <li class="nav-item">
                                <a href="../MRISequences/MRISequences.html" class="nav-link">MRI sequences</a>
                            </li>
                            <li class="nav-item">
                                <a href="../results/results.html" class="nav-link">Results files</a>
                            </li>
                            <li class="nav-item">
                                <a href="advanced.html" class="nav-link">Advanced options</a>
                            </li>
                            <li class="nav-item">
                                <a href="PlanTUS.html" class="nav-link">PlanTUS</a>
                            </li>
                            <li class="nav-item">
                                <a href="TransducerCalibration.html" class="nav-link active" aria-current="page">Tx calibration</a>
                            </li>
                            <li class="nav-item">
                                <a href="../Appendix/Appendix.html" class="nav-link">Appendix</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="PlanTUS.html" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../Appendix/Appendix.html" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="2"><a href="#transducer-calibration" class="nav-link">Transducer calibration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#requirements" class="nav-link">Requirements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#procedure" class="nav-link">Procedure</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#1-identify-range-of-data" class="nav-link">1. Identify range of data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#2-prepare-yaml-file-with-input-information-for-calibration" class="nav-link">2. Prepare YAML file with input information for calibration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#3-run-transducer-calibration-in-babelbrain" class="nav-link">3. Run transducer calibration in BabelBrain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#4-important-notes" class="nav-link">4. Important notes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="transducer-calibration">Transducer calibration</h2>
<p>Starting in r0.8.0, there is the possibility to calibrate ring-type devices such as the CTX-500 and similar based on the reported <strong>intensity</strong> data on axial steering. For example, most reports show an as the one below detailing the steering capabilities of the device:</p>
<p><img src="TxCalibration-1.png" height=350px></p>
<p>This procedure in BabelBrain enables the modelling the specific response of individual transducers, improving precision of simulations.</p>
<h1 id="requirements">Requirements</h1>
<p>Obtain from the vendor an Excel file with the intensity profile data used to produce the intensity report shown above, for example:</p>
<p><img src="TxCalibration-2.png" height=450px></p>
<h1 id="procedure">Procedure</h1>
<h2 id="1-identify-range-of-data">1. Identify range of data</h2>
<p>Identify the range of cells for intensity data needed to produce the plot. The selected table should contain the Z axis distance from the outplane in the first column and the intensity values in the next columns corresponding to each steering in Z. </p>
<p>On the example above, the first cell would be <strong>T20</strong>:</p>
<p><img src="TxCalibration-3.png" height=250px></p>
<p>and the last cell would be <strong>AJ81</strong>:</p>
<p><img src="TxCalibration-4.png" height=250px></p>
<p><strong>VERY IMPORTANT</strong>: Be sure of selecting the cell matching the last steering condition at the deepest Z value, <strong>and nothing else</strong>.</p>
<h2 id="2-prepare-yaml-file-with-input-information-for-calibration">2. Prepare YAML file with input information for calibration</h2>
<p>Details of the Excel sheet and cell range is specified via a simple YAML file as the one shown below</p>
<pre><code class="language-YAML">#be sure of specifying a supported device for calibration (ring array type): CTX_500, CTX_250, CTX_250_2ch, DPX_500, DPXPC_300, R15287, R15473
Device: CTX_500 
ExcelFileProfiles: /Users/spichardo/Documents/CTX-500-117 4-Ch. Focal Steering.xlsx
ExcelRangeProfiles: Sheet1!T20:AJ81
# select an OutputResultsPath that is individual for Tx configuration and frequency
OutputResultsPath: /Users/spichardo/Documents/CTX-500-117 4-Ch. Focal Steering
Lambda: 1.0e-4
# PLEASE BE SURE OF SELECTING A VALID FREQUENCY FOR YOUR DEVICE, also, be sure of format of frequency (i.e 5.0e+5)
Frequency: 5.0e+5 
</code></pre>
<p>where <code>Device</code> is the device type to calibrate; this should match the device selected when BabelBrain was started. <code>ExcelFileProfiles</code> is the file path of the Excel sheet with the report data. <code>ExcelRangeProfiles</code> is the Excel range of cells (including sheet name) of the acoustic profile data as detailed above. <code>OutputResultsPath</code> is the path where the calibration and some verification plots will be saved (if path doesn't exist, it will be created). <code>Lambda</code> is a regularization parameter (10<span class="arithmatex"><span class="MathJax_Preview">^{-4}</span><script type="math/tex">^{-4}</script></span> should work for most transducers) and <code>Frequency</code> is the ultrasound operating frequency (be sure of specifying a frequency supported by the device).</p>
<p>Be sure that the <code>OutputResultsPath</code> is unique per transducer and serial number basis, in case more than one transducer of the same model is available.</p>
<h2 id="3-run-transducer-calibration-in-babelbrain">3. Run transducer calibration in BabelBrain</h2>
<p>Open BabelBrain and select the correct transducer model</p>
<p><img src="TxCalibration-5.png" height=250px></p>
<p>Click on the <code>Advanced Options</code> action, select the <code>Transcranial Ultrasound</code> tab, and click on the <code>YAML file for calibration inputs</code> to select the YAML file defined above.</p>
<p><img src="TxCalibration-6.png" height=350px></p>
<p>Run the calibration with the <code>Execute</code> button and wait for a 1 or 2 min. Once completed, BabelBrain will show results of the fitting procedure where the user can evaluate the improvement to match better the experimental profiles compared to an idealized transducer response as shown below.</p>
<p><img src="TxCalibration-7.png" height=450px></p>
<p>If results are satisfactory, select <code>confirm and accept calibration</code>. The Advanced Options dialog will populate the path to the calibration file (<code>CALIBRATION.h5</code>) indicated in the <code>OutputResultsPath</code> path. Select <code>Ok</code> in the Advanced Options dialog to store this calibration info. </p>
<h2 id="4-important-notes">4. Important notes</h2>
<p>Once accepted and saved as an option, any new acoustic simulation in Step 2 will use the fitted transducer response. This calibration information will be preserved between BabelBrain sessions. If there is need to reset the calibration to the default transducer response, open the Advance Options dialog and clear the path to the calibration file and save with <code>Ok</code>.</p>
<p>BabelBrain will manage the calibration per transducer model basis. For example, if more than one transducer model is available (for example, CTX 500 and DPX 500), individual calibrations can be run and saved. Every time BabelBrain is opened with the different transducer model, BabelBrain will load the specific calibration file for each transducer.</p>
<p>A current <strong>limitation</strong> is that if multiples transducers of the same model are available, and it is desired to run a calibration for each of them, the user should modify the path to the calibration file (<code>CALIBRATION.h5</code>) each time they run simulations and remember that this calibration is saved for the next time BabelBrain is opened.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../mathjax-config.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
